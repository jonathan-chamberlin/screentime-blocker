<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings — Brainrot Blocker</title>
  <style>
    :root {
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --surface-hover: #232340;
      --border: #2a2a45;
      --text: #e0e0ef;
      --text-muted: #8888a8;
      --accent: #6c5ce7;
      --accent-hover: #7d6ff0;
      --green: #00c853;
      --red: #e94560;
      --yellow: #ffd600;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
    }
    .container { max-width: 560px; margin: 0 auto; }

    .header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
    .header h1 { font-size: 22px; font-weight: 700; }
    .back-link {
      color: var(--accent); text-decoration: none; font-size: 14px;
      padding: 6px 12px; border-radius: 6px; background: var(--surface);
      border: 1px solid var(--border);
    }
    .back-link:hover { background: var(--surface-hover); }

    .save-indicator {
      position: fixed; top: 16px; right: 16px;
      background: var(--green); color: #000; font-size: 13px; font-weight: 600;
      padding: 6px 14px; border-radius: 20px;
      opacity: 0; transition: opacity 0.3s; pointer-events: none;
    }
    .save-indicator.visible { opacity: 1; }

    /* Sections */
    .section {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; margin-bottom: 12px; overflow: hidden;
    }
    .section-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 16px; cursor: pointer; user-select: none;
    }
    .section-header:hover { background: var(--surface-hover); }
    .section-title { font-size: 15px; font-weight: 600; }
    .section-arrow { font-size: 12px; color: var(--text-muted); transition: transform 0.2s; }
    .section.open .section-arrow { transform: rotate(90deg); }
    .section-body { display: none; padding: 0 16px 16px; }
    .section.open .section-body { display: block; }

    /* Form rows */
    .form-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-bottom: 1px solid var(--border);
    }
    .form-row:last-child { border-bottom: none; }
    .form-row .label { font-size: 14px; }
    .form-row .desc { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    select {
      background: var(--bg); color: var(--text);
      border: 1px solid var(--border); border-radius: 6px;
      padding: 6px 10px; font-size: 13px; cursor: pointer; min-width: 100px;
    }
    select:focus { outline: none; border-color: var(--accent); }

    .switch {
      position: relative; width: 44px; height: 24px;
      background: var(--border); border-radius: 12px; cursor: pointer;
      transition: background 0.2s; flex-shrink: 0;
    }
    .switch.on { background: var(--accent); }
    .switch .knob {
      position: absolute; top: 3px; left: 3px;
      width: 18px; height: 18px; border-radius: 50%;
      background: white; transition: transform 0.2s;
    }
    .switch.on .knob { transform: translateX(20px); }

    /* Tag list */
    .tag-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .tag {
      display: inline-flex; align-items: center; gap: 4px;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 6px; padding: 4px 10px; font-size: 13px;
    }
    .tag .remove {
      cursor: pointer; color: var(--red); font-weight: bold;
      margin-left: 4px; font-size: 14px; line-height: 1;
    }
    .tag .remove:hover { color: #ff6b81; }

    .add-row { display: flex; gap: 8px; margin-top: 8px; }
    .add-row input {
      flex: 1; background: var(--bg); color: var(--text);
      border: 1px solid var(--border); border-radius: 6px;
      padding: 6px 10px; font-size: 13px;
    }
    .add-row input:focus { outline: none; border-color: var(--accent); }
    .add-row button, .btn-small {
      background: var(--accent); color: white; border: none;
      border-radius: 6px; padding: 6px 14px; font-size: 13px;
      cursor: pointer; font-weight: 600;
    }
    .add-row button:hover, .btn-small:hover { background: var(--accent-hover); }

    /* List cards */
    .list-card {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 10px; padding: 12px; margin-bottom: 10px;
    }
    .list-card-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 8px;
    }
    .list-card-header .list-name {
      font-size: 15px; font-weight: 600; cursor: pointer;
      background: none; border: none; color: var(--text);
      border-bottom: 1px dashed var(--border); padding: 2px 4px;
    }
    .list-card-header .list-name:focus {
      outline: none; border-bottom-color: var(--accent);
    }
    .list-card-actions { display: flex; gap: 6px; align-items: center; }
    .btn-delete {
      background: none; border: none; color: var(--red);
      cursor: pointer; font-size: 16px; padding: 2px 6px;
    }
    .btn-delete:hover { color: #ff6b81; }

    .list-subsection { margin-top: 10px; }
    .list-subsection .sub-label {
      font-size: 12px; color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.5px; margin-bottom: 4px;
    }

    /* Mode selector for break lists */
    .mode-select {
      background: var(--surface); color: var(--text);
      border: 1px solid var(--border); border-radius: 6px;
      padding: 4px 8px; font-size: 12px; cursor: pointer;
    }
    .mode-select:focus { outline: none; border-color: var(--accent); }

    .btn-add-list {
      width: 100%; padding: 10px; font-size: 13px; font-weight: 600;
      background: var(--surface); color: var(--accent);
      border: 1px dashed var(--border); border-radius: 10px;
      cursor: pointer; margin-top: 4px;
    }
    .btn-add-list:hover { background: var(--surface-hover); border-color: var(--accent); }

    .mode-toggle {
      display: flex; border-radius: 8px; overflow: hidden;
      border: 1px solid var(--border); margin-top: 8px;
    }
    .mode-toggle button {
      flex: 1; padding: 8px 12px; font-size: 13px;
      background: var(--bg); color: var(--text-muted);
      border: none; cursor: pointer; font-weight: 500;
    }
    .mode-toggle button.active { background: var(--accent); color: white; }

    .btn-danger {
      background: var(--red); color: white; border: none;
      border-radius: 6px; cursor: pointer;
    }
    .btn-danger:hover { background: #d63050; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="/" class="back-link">&larr; Dashboard</a>
      <h1>Settings</h1>
    </div>

    <div class="save-indicator" id="saveIndicator">Saved</div>

    <!-- Sessions -->
    <div class="section open" id="sec-sessions">
      <div class="section-header" onclick="toggleSection('sec-sessions')">
        <span class="section-title">Sessions</span>
        <span class="section-arrow">&#9654;</span>
      </div>
      <div class="section-body">
        <div class="form-row">
          <div><div class="label">Work Duration</div><div class="desc">How long each focus session lasts</div></div>
          <select id="workMinutes" data-key="workMinutes"></select>
        </div>
        <div class="form-row">
          <div><div class="label">Break Duration</div><div class="desc">Reward time earned per session</div></div>
          <select id="rewardMinutes" data-key="rewardMinutes"></select>
        </div>
        <div class="form-row">
          <div><div class="label">Strict Mode</div><div class="desc">Must earn reward before ending</div></div>
          <div class="switch" id="toggle-strictMode" data-key="strictMode"><div class="knob"></div></div>
        </div>
        <div class="form-row">
          <div><div class="label">Block Task Manager</div><div class="desc">Kill Task Manager during sessions</div></div>
          <div class="switch" id="toggle-blockTaskManager" data-key="blockTaskManager"><div class="knob"></div></div>
        </div>
      </div>
    </div>

    <!-- Idle Timeout -->
    <div class="section" id="sec-idle">
      <div class="section-header" onclick="toggleSection('sec-idle')">
        <span class="section-title">Idle Timeout</span>
        <span class="section-arrow">&#9654;</span>
      </div>
      <div class="section-body">
        <div class="form-row">
          <div><div class="label">Pause timers after</div><div class="desc">Timers pause when idle</div></div>
          <select id="idleTimeoutSeconds" data-key="idleTimeoutSeconds"></select>
        </div>
      </div>
    </div>

    <!-- What is Distracting — Break Lists -->
    <div class="section" id="sec-distracting">
      <div class="section-header" onclick="toggleSection('sec-distracting')">
        <span class="section-title">What is Distracting</span>
        <span class="section-arrow">&#9654;</span>
      </div>
      <div class="section-body">
        <div class="desc" style="margin-bottom: 10px;">
          Manage your block lists. Each list has its own sites, apps, and allowed path exceptions.
        </div>
        <div id="breakListsContainer"></div>
        <button class="btn-add-list" onclick="addBreakList()">+ New Block List</button>
      </div>
    </div>

    <!-- What is Productive — Productive Lists -->
    <div class="section" id="sec-productive">
      <div class="section-header" onclick="toggleSection('sec-productive')">
        <span class="section-title">What is Productive</span>
        <span class="section-arrow">&#9654;</span>
      </div>
      <div class="section-body">
        <div class="form-row" style="flex-direction: column; align-items: stretch;">
          <div class="label" style="margin-bottom: 4px;">Productive Mode</div>
          <div class="mode-toggle" id="productiveModeToggle">
            <button data-mode="all-except-blocked" onclick="setProductiveMode('all-except-blocked')">All except blocked</button>
            <button data-mode="whitelist" onclick="setProductiveMode('whitelist')">Whitelist only</button>
          </div>
        </div>
        <div style="margin-top: 14px;">
          <div id="productiveListsContainer"></div>
          <button class="btn-add-list" onclick="addProductiveList()">+ New Productive List</button>
        </div>
      </div>
    </div>

    <!-- Blocked Apps -->
    <div class="section" id="sec-apps">
      <div class="section-header" onclick="toggleSection('sec-apps')">
        <span class="section-title">Blocked Apps</span>
        <span class="section-arrow">&#9654;</span>
      </div>
      <div class="section-body">
        <div class="desc" style="margin-bottom: 8px;">Apps killed during focus sessions</div>
        <div class="tag-list" id="blockedAppsTags"></div>
        <div class="add-row">
          <input type="text" id="addBlockedApp" placeholder="e.g. steam.exe">
          <button onclick="addBlockedApp()">Add</button>
        </div>
      </div>
    </div>

    <!-- Nuclear Block -->
    <div class="section" id="sec-nuclear">
      <div class="section-header" onclick="toggleSection('sec-nuclear')">
        <span class="section-title">Nuclear Block</span>
        <span class="section-arrow">&#9654;</span>
      </div>
      <div class="section-body">
        <div class="desc" style="margin-bottom: 8px;">Permanently blocked with cooldown-based unblock</div>
        <div class="tag-list" id="nuclearSitesTags"></div>
        <div class="add-row">
          <input type="text" id="addNuclearSite" placeholder="e.g. onlyfans.com">
          <button onclick="addNuclearSiteEntry()">Add</button>
        </div>
      </div>
    </div>

    <!-- Advanced -->
    <div class="section" id="sec-advanced">
      <div class="section-header" onclick="toggleSection('sec-advanced')">
        <span class="section-title">Advanced</span>
        <span class="section-arrow">&#9654;</span>
      </div>
      <div class="section-body">
        <div class="form-row">
          <div><div class="label">Reset All Settings</div><div class="desc">Restore defaults (keeps nuclear blocks)</div></div>
          <button class="btn-danger" style="padding: 6px 14px; font-size: 13px;" onclick="resetSettings()">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ========== Dropdown Definitions ========== */
    const WORK_OPTIONS = [
      { value: 0.083, label: '5s (test)' }, { value: 0.167, label: '10s (test)' },
      { value: 1, label: '1 min' }, { value: 5, label: '5 min' }, { value: 10, label: '10 min' },
      { value: 15, label: '15 min' }, { value: 25, label: '25 min' }, { value: 50, label: '50 min' },
      { value: 90, label: '90 min' }, { value: 120, label: '2 hours' }, { value: 180, label: '3 hours' },
    ];
    const REWARD_OPTIONS = [
      { value: 0.083, label: '5s (test)' }, { value: 0.167, label: '10s (test)' },
      { value: 1, label: '1 min' }, { value: 5, label: '5 min' }, { value: 10, label: '10 min' },
      { value: 15, label: '15 min' }, { value: 30, label: '30 min' }, { value: 60, label: '60 min' },
    ];
    const IDLE_OPTIONS = [
      { value: 5, label: '5s (test)' }, { value: 10, label: '10 sec' }, { value: 30, label: '30 sec' },
      { value: 60, label: '1 min' }, { value: 120, label: '2 min' }, { value: 180, label: '3 min' },
      { value: 300, label: '5 min' },
    ];
    const MODE_OPTIONS = [
      { value: 'off', label: 'Off' }, { value: 'manual', label: 'Manual' },
      { value: 'scheduled', label: 'Scheduled' }, { value: 'always-on', label: 'Always On' },
    ];

    let settings = {};

    /* ========== Utility Functions ========== */

    function populateSelect(id, options, currentValue) {
      const el = document.getElementById(id);
      el.innerHTML = '';
      for (const opt of options) {
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        if (opt.value === currentValue) o.selected = true;
        el.appendChild(o);
      }
    }

    function flashSaved() {
      const el = document.getElementById('saveIndicator');
      el.classList.add('visible');
      setTimeout(() => el.classList.remove('visible'), 1200);
    }

    async function save(updates) {
      try {
        const res = await fetch('/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates),
        });
        settings = await res.json();
        flashSaved();
        renderAll();
      } catch (e) {
        console.error('Save failed:', e);
      }
    }

    function toggleSection(id) {
      document.getElementById(id).classList.toggle('open');
    }

    function setupToggle(id) {
      const el = document.getElementById(id);
      el.addEventListener('click', () => {
        const key = el.dataset.key;
        const isOn = el.classList.contains('on');
        el.classList.toggle('on', !isOn);
        save({ [key]: !isOn });
      });
    }

    function setupSelect(id, parseValue) {
      const el = document.getElementById(id);
      el.addEventListener('change', () => {
        save({ [el.dataset.key]: parseValue(el.value) });
      });
    }

    function setProductiveMode(mode) {
      save({ productiveMode: mode });
    }

    function updateProductiveModeUI(mode) {
      document.querySelectorAll('#productiveModeToggle button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
    }

    /** Generate a simple UUID */
    function uuid() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
      });
    }

    /* ========== Break List CRUD ========== */

    function addBreakList() {
      const lists = settings.breakLists || [];
      lists.push({
        id: uuid(),
        name: 'New Block List',
        isActive: false,
        mode: 'manual',
        sites: [],
        apps: [],
        allowedPaths: [],
        schedule: null,
      });
      save({ breakLists: lists });
    }

    function deleteBreakList(listId) {
      const lists = settings.breakLists || [];
      if (lists.length <= 1) return; // can't delete last list
      const filtered = lists.filter(l => l.id !== listId);
      const updates = { breakLists: filtered };
      // If we deleted the active list, switch to the first remaining
      if (settings.activeBreakListId === listId) {
        updates.activeBreakListId = filtered[0].id;
      }
      save(updates);
    }

    function renameBreakList(listId, newName) {
      const list = (settings.breakLists || []).find(l => l.id === listId);
      if (!list || list.name === newName) return;
      list.name = newName;
      save({ breakLists: settings.breakLists });
    }

    function changeBreakListMode(listId, mode) {
      const list = (settings.breakLists || []).find(l => l.id === listId);
      if (!list) return;
      list.mode = mode;
      save({ breakLists: settings.breakLists });
    }

    function addToBreakList(listId, field, inputId) {
      const input = document.getElementById(inputId);
      const value = input.value.trim().toLowerCase();
      if (!value) return;
      input.value = '';
      const list = (settings.breakLists || []).find(l => l.id === listId);
      if (!list) return;
      if (list[field].includes(value)) return;
      list[field].push(value);
      save({ breakLists: settings.breakLists });
    }

    function removeFromBreakList(listId, field, index) {
      const list = (settings.breakLists || []).find(l => l.id === listId);
      if (!list) return;
      list[field].splice(index, 1);
      save({ breakLists: settings.breakLists });
    }

    /* ========== Productive List CRUD ========== */

    function addProductiveList() {
      const lists = settings.productiveLists || [];
      lists.push({
        id: uuid(),
        name: 'New Productive List',
        isActive: false,
        sites: [],
        apps: [],
      });
      save({ productiveLists: lists });
    }

    function deleteProductiveList(listId) {
      const lists = settings.productiveLists || [];
      if (lists.length <= 1) return;
      const filtered = lists.filter(l => l.id !== listId);
      const updates = { productiveLists: filtered };
      if (settings.activeProductiveListId === listId) {
        updates.activeProductiveListId = filtered[0].id;
      }
      save(updates);
    }

    function renameProductiveList(listId, newName) {
      const list = (settings.productiveLists || []).find(l => l.id === listId);
      if (!list || list.name === newName) return;
      list.name = newName;
      save({ productiveLists: settings.productiveLists });
    }

    function addToProductiveList(listId, field, inputId) {
      const input = document.getElementById(inputId);
      const value = input.value.trim().toLowerCase();
      if (!value) return;
      input.value = '';
      const list = (settings.productiveLists || []).find(l => l.id === listId);
      if (!list) return;
      if (list[field].includes(value)) return;
      list[field].push(value);
      save({ productiveLists: settings.productiveLists });
    }

    function removeFromProductiveList(listId, field, index) {
      const list = (settings.productiveLists || []).find(l => l.id === listId);
      if (!list) return;
      list[field].splice(index, 1);
      save({ productiveLists: settings.productiveLists });
    }

    /* ========== Blocked Apps ========== */

    function addBlockedApp() {
      const input = document.getElementById('addBlockedApp');
      const value = input.value.trim().toLowerCase();
      if (!value) return;
      input.value = '';
      const apps = settings.blockedApps || [];
      if (apps.includes(value)) return;
      apps.push(value);
      save({ blockedApps: apps });
    }

    function removeBlockedApp(index) {
      const apps = settings.blockedApps || [];
      apps.splice(index, 1);
      save({ blockedApps: apps });
    }

    /* ========== Nuclear ========== */

    function addNuclearSiteEntry() {
      const input = document.getElementById('addNuclearSite');
      const domain = input.value.trim().toLowerCase();
      if (!domain) return;
      input.value = '';
      const nuclear = settings.nuclearBlockData || { sites: [] };
      if (nuclear.sites.some(s => s.domain === domain)) return;
      nuclear.sites.push({
        domain, addedAt: Date.now(),
        cooldown1Ms: 86400000, cooldown2Ms: 64800000, unblockClickedAt: null,
      });
      save({ nuclearBlockData: nuclear });
    }

    function removeNuclearSite(index) {
      const nuclear = settings.nuclearBlockData || { sites: [] };
      nuclear.sites.splice(index, 1);
      save({ nuclearBlockData: nuclear });
    }

    /* ========== Reset ========== */

    async function resetSettings() {
      if (!confirm('Reset all settings to defaults? Nuclear blocks will be preserved.')) return;
      try {
        const nuclearBackup = settings.nuclearBlockData;
        await fetch('/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            workMinutes: 50, rewardMinutes: 10,
            strictMode: false, blockTaskManager: false,
            idleTimeoutSeconds: 180, productiveMode: 'all-except-blocked',
            nuclearBlockData: nuclearBackup,
          }),
        });
        await loadSettings();
        flashSaved();
      } catch (e) { console.error('Reset failed:', e); }
    }

    /* ========== Rendering ========== */

    /** Render tags with remove buttons */
    function renderTagsHTML(items, removeFn) {
      return items.map((item, i) =>
        `<span class="tag">${item} <span class="remove" onclick="${removeFn}(${i})">&times;</span></span>`
      ).join('');
    }

    /** Render all break list cards */
    function renderBreakLists() {
      const container = document.getElementById('breakListsContainer');
      const lists = settings.breakLists || [];
      const canDelete = lists.length > 1;
      const isActive = (id) => id === settings.activeBreakListId;

      container.innerHTML = lists.map(list => {
        const modeOpts = MODE_OPTIONS.map(o =>
          `<option value="${o.value}" ${o.value === list.mode ? 'selected' : ''}>${o.label}</option>`
        ).join('');
        const activeLabel = isActive(list.id) ? ' (active)' : '';

        return `
          <div class="list-card">
            <div class="list-card-header">
              <input class="list-name" value="${list.name}${activeLabel}"
                onfocus="this.value=this.value.replace(' (active)','')"
                onblur="renameBreakList('${list.id}', this.value.replace(' (active)',''))">
              <div class="list-card-actions">
                <select class="mode-select" onchange="changeBreakListMode('${list.id}', this.value)">${modeOpts}</select>
                ${canDelete ? `<button class="btn-delete" onclick="deleteBreakList('${list.id}')" title="Delete">&times;</button>` : ''}
              </div>
            </div>
            <div class="list-subsection">
              <div class="sub-label">Blocked Sites</div>
              <div class="tag-list">${renderTagsHTML(list.sites || [], `removeFromBreakList.bind(null,'${list.id}','sites')`)}</div>
              <div class="add-row">
                <input type="text" id="addBLSite-${list.id}" placeholder="e.g. tiktok.com"
                  onkeydown="if(event.key==='Enter')addToBreakList('${list.id}','sites','addBLSite-${list.id}')">
                <button onclick="addToBreakList('${list.id}','sites','addBLSite-${list.id}')">Add</button>
              </div>
            </div>
            <div class="list-subsection">
              <div class="sub-label">Allowed Paths</div>
              <div class="tag-list">${renderTagsHTML(list.allowedPaths || [], `removeFromBreakList.bind(null,'${list.id}','allowedPaths')`)}</div>
              <div class="add-row">
                <input type="text" id="addBLPath-${list.id}" placeholder="e.g. youtube.com/veritasium"
                  onkeydown="if(event.key==='Enter')addToBreakList('${list.id}','allowedPaths','addBLPath-${list.id}')">
                <button onclick="addToBreakList('${list.id}','allowedPaths','addBLPath-${list.id}')">Add</button>
              </div>
            </div>
            <div class="list-subsection">
              <div class="sub-label">Blocked Apps</div>
              <div class="tag-list">${renderTagsHTML(list.apps || [], `removeFromBreakList.bind(null,'${list.id}','apps')`)}</div>
              <div class="add-row">
                <input type="text" id="addBLApp-${list.id}" placeholder="e.g. discord.exe"
                  onkeydown="if(event.key==='Enter')addToBreakList('${list.id}','apps','addBLApp-${list.id}')">
                <button onclick="addToBreakList('${list.id}','apps','addBLApp-${list.id}')">Add</button>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    /** Render all productive list cards */
    function renderProductiveLists() {
      const container = document.getElementById('productiveListsContainer');
      const lists = settings.productiveLists || [];
      const canDelete = lists.length > 1;
      const isActive = (id) => id === settings.activeProductiveListId;

      container.innerHTML = lists.map(list => {
        const activeLabel = isActive(list.id) ? ' (active)' : '';
        return `
          <div class="list-card">
            <div class="list-card-header">
              <input class="list-name" value="${list.name}${activeLabel}"
                onfocus="this.value=this.value.replace(' (active)','')"
                onblur="renameProductiveList('${list.id}', this.value.replace(' (active)',''))">
              <div class="list-card-actions">
                ${canDelete ? `<button class="btn-delete" onclick="deleteProductiveList('${list.id}')" title="Delete">&times;</button>` : ''}
              </div>
            </div>
            <div class="list-subsection">
              <div class="sub-label">Productive Sites</div>
              <div class="tag-list">${renderTagsHTML(list.sites || [], `removeFromProductiveList.bind(null,'${list.id}','sites')`)}</div>
              <div class="add-row">
                <input type="text" id="addPLSite-${list.id}" placeholder="e.g. stackoverflow.com"
                  onkeydown="if(event.key==='Enter')addToProductiveList('${list.id}','sites','addPLSite-${list.id}')">
                <button onclick="addToProductiveList('${list.id}','sites','addPLSite-${list.id}')">Add</button>
              </div>
            </div>
            <div class="list-subsection">
              <div class="sub-label">Productive Apps</div>
              <div class="tag-list">${renderTagsHTML(list.apps || [], `removeFromProductiveList.bind(null,'${list.id}','apps')`)}</div>
              <div class="add-row">
                <input type="text" id="addPLApp-${list.id}" placeholder="e.g. Code.exe"
                  onkeydown="if(event.key==='Enter')addToProductiveList('${list.id}','apps','addPLApp-${list.id}')">
                <button onclick="addToProductiveList('${list.id}','apps','addPLApp-${list.id}')">Add</button>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    function renderBlockedApps() {
      const container = document.getElementById('blockedAppsTags');
      container.innerHTML = (settings.blockedApps || []).map((app, i) =>
        `<span class="tag">${app} <span class="remove" onclick="removeBlockedApp(${i})">&times;</span></span>`
      ).join('');
    }

    function renderNuclearTags() {
      const container = document.getElementById('nuclearSitesTags');
      const sites = settings.nuclearBlockData?.sites || [];
      container.innerHTML = sites.map((s, i) =>
        `<span class="tag">${s.domain} <span class="remove" onclick="removeNuclearSite(${i})">&times;</span></span>`
      ).join('');
    }

    function renderAll() {
      renderBreakLists();
      renderProductiveLists();
      renderBlockedApps();
      renderNuclearTags();
      updateProductiveModeUI(settings.productiveMode);
    }

    /* ========== Load & Init ========== */

    async function loadSettings() {
      try {
        const res = await fetch('/api/settings');
        settings = await res.json();
        populateSelect('workMinutes', WORK_OPTIONS, settings.workMinutes);
        populateSelect('rewardMinutes', REWARD_OPTIONS, settings.rewardMinutes);
        populateSelect('idleTimeoutSeconds', IDLE_OPTIONS, settings.idleTimeoutSeconds);
        document.getElementById('toggle-strictMode').classList.toggle('on', settings.strictMode);
        document.getElementById('toggle-blockTaskManager').classList.toggle('on', settings.blockTaskManager);
        renderAll();
      } catch (e) { console.error('Failed to load settings:', e); }
    }

    setupToggle('toggle-strictMode');
    setupToggle('toggle-blockTaskManager');
    setupSelect('workMinutes', parseFloat);
    setupSelect('rewardMinutes', parseFloat);
    setupSelect('idleTimeoutSeconds', parseInt);

    function connectWS() {
      const ws = new WebSocket(`ws://${location.host}`);
      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'settings-updated') {
          settings = msg.data;
          renderAll();
        }
      };
      ws.onclose = () => setTimeout(connectWS, 2000);
    }
    connectWS();
    loadSettings();
  </script>
</body>
</html>
