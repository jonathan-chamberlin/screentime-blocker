<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings — Brainrot Blocker</title>
  <style>
    :root {
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --surface-hover: #232340;
      --border: #2a2a45;
      --text: #e0e0ef;
      --text-muted: #8888a8;
      --accent: #6c5ce7;
      --accent-hover: #7d6ff0;
      --green: #00c853;
      --red: #e94560;
      --yellow: #ffd600;
      --orange: #ff9100;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
    }
    .container { max-width: 580px; margin: 0 auto; }

    /* Header */
    .header { display: flex; align-items: center; gap: 12px; margin-bottom: 28px; }
    .header h1 { font-size: 22px; font-weight: 700; }
    .back-link {
      color: var(--accent); text-decoration: none; font-size: 14px;
      padding: 6px 12px; border-radius: 6px; background: var(--surface);
      border: 1px solid var(--border);
    }
    .back-link:hover { background: var(--surface-hover); }

    /* Save indicator */
    .save-indicator {
      position: fixed; top: 16px; right: 16px;
      background: var(--green); color: #000; font-size: 13px; font-weight: 600;
      padding: 6px 14px; border-radius: 20px;
      opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 999;
    }
    .save-indicator.visible { opacity: 1; }

    /* Collapsible sections */
    .section {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; margin-bottom: 12px; overflow: hidden;
    }
    .section-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 16px; cursor: pointer; user-select: none;
    }
    .section-header:hover { background: var(--surface-hover); }
    .section-title { font-size: 15px; font-weight: 600; }
    .section-arrow { font-size: 12px; color: var(--text-muted); transition: transform 0.2s; }
    .section.open .section-arrow { transform: rotate(90deg); }
    .section-body { display: none; padding: 0 16px 16px; }
    .section.open .section-body { display: block; }

    /* Form rows */
    .form-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-bottom: 1px solid var(--border);
    }
    .form-row:last-child { border-bottom: none; }
    .form-row .label { font-size: 14px; }
    .form-row .desc { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    /* Select */
    select {
      background: var(--bg); color: var(--text);
      border: 1px solid var(--border); border-radius: 6px;
      padding: 6px 10px; font-size: 13px; cursor: pointer; min-width: 110px;
    }
    select:focus { outline: none; border-color: var(--accent); }

    /* Toggle switch */
    .switch {
      position: relative; width: 44px; height: 24px;
      background: var(--border); border-radius: 12px; cursor: pointer;
      transition: background 0.2s; flex-shrink: 0;
    }
    .switch.on { background: var(--accent); }
    .switch .knob {
      position: absolute; top: 3px; left: 3px;
      width: 18px; height: 18px; border-radius: 50%;
      background: white; transition: transform 0.2s;
    }
    .switch.on .knob { transform: translateX(20px); }

    /* Tag list */
    .tag-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; min-height: 6px; }
    .tag {
      display: inline-flex; align-items: center; gap: 4px;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 6px; padding: 4px 10px; font-size: 13px;
    }
    .tag button {
      background: none; border: none; cursor: pointer; color: var(--red);
      font-weight: bold; font-size: 14px; line-height: 1; padding: 0 0 0 4px;
    }
    .tag button:hover { color: #ff6b81; }

    /* Add row */
    .add-row { display: flex; gap: 8px; margin-top: 8px; }
    .add-row input {
      flex: 1; background: var(--bg); color: var(--text);
      border: 1px solid var(--border); border-radius: 6px;
      padding: 6px 10px; font-size: 13px;
    }
    .add-row input:focus { outline: none; border-color: var(--accent); }
    .add-row button {
      background: var(--accent); color: white; border: none;
      border-radius: 6px; padding: 6px 14px; font-size: 13px;
      cursor: pointer; font-weight: 600; white-space: nowrap;
    }
    .add-row button:hover { background: var(--accent-hover); }

    /* List cards */
    .list-card {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 10px; margin-bottom: 8px; overflow: hidden;
    }
    .list-card-header {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 14px; cursor: pointer; user-select: none;
    }
    .list-card-header:hover { background: rgba(255,255,255,0.03); }
    .list-card-name { font-size: 14px; font-weight: 600; flex: 1; }
    .list-card-summary { font-size: 12px; color: var(--text-muted); }
    .list-card-arrow { font-size: 11px; color: var(--text-muted); transition: transform 0.2s; flex-shrink: 0; }
    .list-card.open .list-card-arrow { transform: rotate(90deg); }

    /* Mode badge */
    .mode-badge {
      font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px;
      flex-shrink: 0; text-transform: capitalize;
    }
    .mode-badge-off { background: rgba(136,136,168,0.2); color: var(--text-muted); }
    .mode-badge-manual { background: rgba(108,92,231,0.25); color: var(--accent-hover); }
    .mode-badge-scheduled { background: rgba(255,214,0,0.2); color: var(--yellow); }
    .mode-badge-always-on { background: rgba(0,200,83,0.2); color: var(--green); }

    /* List card body */
    .list-card-body { display: none; padding: 0 14px 14px; border-top: 1px solid var(--border); }
    .list-card.open .list-card-body { display: block; }

    /* Within-card field groups */
    .card-field { margin-top: 14px; }
    .card-field-label {
      font-size: 12px; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;
    }
    .card-field-sublabel { font-size: 11px; color: var(--text-muted); margin-top: 2px; margin-bottom: 2px; }

    /* Within-card section headings */
    .card-section-heading {
      font-size: 13px; font-weight: 700; color: var(--text);
      margin-top: 18px; margin-bottom: 2px;
      padding-bottom: 6px; border-bottom: 1px solid var(--border);
    }

    .card-name-input {
      width: 100%; background: var(--bg); color: var(--text);
      border: 1px solid var(--border); border-radius: 6px;
      padding: 7px 10px; font-size: 14px; font-weight: 600;
    }
    .card-name-input:focus { outline: none; border-color: var(--accent); }

    .card-mode-select {
      background: var(--bg); color: var(--text);
      border: 1px solid var(--border); border-radius: 6px;
      padding: 6px 10px; font-size: 13px; cursor: pointer; width: 100%;
    }
    .card-mode-select:focus { outline: none; border-color: var(--accent); }

    /* Productive mode radios */
    .radio-group { display: flex; flex-direction: column; gap: 8px; margin-top: 6px; }
    .radio-label {
      display: flex; align-items: center; gap: 8px;
      cursor: pointer; font-size: 13px;
    }
    .radio-label input[type="radio"] { accent-color: var(--accent); cursor: pointer; }

    /* Delete button inside card */
    .btn-delete-list {
      width: 100%; margin-top: 18px; padding: 8px; font-size: 13px; font-weight: 600;
      background: rgba(233,69,96,0.1); color: var(--red);
      border: 1px solid rgba(233,69,96,0.3); border-radius: 8px; cursor: pointer;
    }
    .btn-delete-list:hover { background: rgba(233,69,96,0.2); }
    .btn-delete-list:disabled { opacity: 0.35; cursor: not-allowed; }

    /* New list button */
    .btn-add-list {
      width: 100%; padding: 10px; font-size: 13px; font-weight: 600;
      background: var(--surface); color: var(--accent);
      border: 1px dashed var(--border); border-radius: 10px;
      cursor: pointer; margin-top: 4px;
    }
    .btn-add-list:hover { background: var(--surface-hover); border-color: var(--accent); }

    /* Danger button */
    .btn-danger {
      background: var(--red); color: white; border: none;
      border-radius: 6px; padding: 6px 14px; font-size: 13px;
      cursor: pointer; font-weight: 600;
    }
    .btn-danger:hover { background: #d63050; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="/" class="back-link">&larr; Dashboard</a>
      <h1>Settings</h1>
    </div>

    <div class="save-indicator" id="saveIndicator">Saved</div>

    <!-- Section 1: Idle Timeout -->
    <div class="section" id="sec-idle">
      <div class="section-header" onclick="toggleSection('sec-idle')">
        <span class="section-title">Idle Timeout</span>
        <span class="section-arrow">&#9654;</span>
      </div>
      <div class="section-body">
        <div class="form-row">
          <div>
            <div class="label">Pause timers after</div>
            <div class="desc">Timers pause when keyboard/mouse idle</div>
          </div>
          <select id="idleTimeoutSeconds" data-key="idleTimeoutSeconds"></select>
        </div>
      </div>
    </div>

    <!-- Section 3: Lists -->
    <div class="section open" id="sec-lists">
      <div class="section-header" onclick="toggleSection('sec-lists')">
        <span class="section-title">Lists</span>
        <span class="section-arrow">&#9654;</span>
      </div>
      <div class="section-body">
        <div id="listsContainer"></div>
        <button class="btn-add-list" onclick="addList()">+ New List</button>
      </div>
    </div>

    <!-- Section 3: Nuclear Block -->
    <div class="section" id="sec-nuclear">
      <div class="section-header" onclick="toggleSection('sec-nuclear')">
        <span class="section-title">Nuclear Block</span>
        <span class="section-arrow">&#9654;</span>
      </div>
      <div class="section-body">
        <div class="desc" style="margin-bottom: 8px; font-size: 13px; color: var(--text-muted);">
          Permanently blocked sites with cooldown-based unblock
        </div>
        <div class="tag-list" id="nuclearSitesTags"></div>
        <div class="add-row">
          <input type="text" id="addNuclearSite" placeholder="e.g. onlyfans.com"
            onkeydown="if(event.key==='Enter')addNuclearSiteEntry()">
          <button onclick="addNuclearSiteEntry()">Add</button>
        </div>
      </div>
    </div>

    <!-- Section 7: Advanced -->
    <div class="section" id="sec-advanced">
      <div class="section-header" onclick="toggleSection('sec-advanced')">
        <span class="section-title">Advanced</span>
        <span class="section-arrow">&#9654;</span>
      </div>
      <div class="section-body">
        <div class="form-row">
          <div>
            <div class="label">Reset All Settings</div>
            <div class="desc">Restore defaults (nuclear blocks preserved)</div>
          </div>
          <button class="btn-danger" onclick="resetSettings()">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== Dropdown Definitions ===== */
    const IDLE_OPTIONS = [
      { value: 5, label: '5s (test)' }, { value: 10, label: '10 sec' }, { value: 30, label: '30 sec' },
      { value: 60, label: '1 min' }, { value: 120, label: '2 min' }, { value: 180, label: '3 min' },
      { value: 300, label: '5 min' },
    ];
    const MODE_OPTIONS = [
      { value: 'off', label: 'Off' }, { value: 'manual', label: 'Manual' },
      { value: 'scheduled', label: 'Scheduled' }, { value: 'always-on', label: 'Always On' },
    ];

    /* ===== State ===== */
    let settings = {};
    let expandedListId = null;

    /* ===== Utilities ===== */

    function toggleSection(id) {
      document.getElementById(id).classList.toggle('open');
    }

    function flashSaved() {
      const el = document.getElementById('saveIndicator');
      el.classList.add('visible');
      setTimeout(() => el.classList.remove('visible'), 1200);
    }

    function populateSelect(id, options, currentValue) {
      const el = document.getElementById(id);
      if (!el) return;
      el.innerHTML = '';
      for (const opt of options) {
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        if (String(opt.value) === String(currentValue)) o.selected = true;
        el.appendChild(o);
      }
    }

    function setupSelect(id, parseValue) {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('change', () => {
        save({ [el.dataset.key]: parseValue(el.value) });
      });
    }

    function setupToggle(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('click', () => {
        const key = el.dataset.key;
        const isOn = el.classList.contains('on');
        save({ [key]: !isOn });
      });
    }

    function modeBadgeClass(mode) {
      return `mode-badge mode-badge-${mode || 'off'}`;
    }

    function modeBadgeLabel(mode) {
      const found = MODE_OPTIONS.find(o => o.value === mode);
      return found ? found.label : (mode || 'Off');
    }

    function renderTags(items, onRemoveExpr) {
      return (items || []).map((item, i) =>
        `<span class="tag">${escHtml(item)}<button onclick="${onRemoveExpr}(${i})">&times;</button></span>`
      ).join('');
    }

    function escHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    /* ===== API ===== */

    async function loadSettings() {
      try {
        const res = await fetch('/api/settings');
        settings = await res.json();
        populateSelect('idleTimeoutSeconds', IDLE_OPTIONS, settings.idleTimeoutSeconds);
        renderAll();
      } catch (e) {
        console.error('Failed to load settings:', e);
      }
    }

    async function save(updates) {
      try {
        const res = await fetch('/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates),
        });
        settings = await res.json();
        flashSaved();
        renderAll();
      } catch (e) {
        console.error('Save failed:', e);
      }
    }

    /* ===== List CRUD ===== */

    function addList() {
      const lists = settings.lists ? [...settings.lists] : [];
      const newId = crypto.randomUUID();
      lists.push({
        id: newId,
        name: 'New List',
        mode: 'manual',
        blocked: { sites: [], apps: [], allowedPaths: [] },
        productive: { mode: 'all-except-blocked', sites: [], apps: [] },
      });
      expandedListId = newId;
      save({ lists });
    }

    function deleteList(id) {
      const lists = settings.lists || [];
      if (lists.length <= 1) return;
      const filtered = lists.filter(l => l.id !== id);
      const updates = { lists: filtered };
      if (settings.activeListId === id) {
        updates.activeListId = filtered[0].id;
      }
      if (expandedListId === id) expandedListId = null;
      save(updates);
    }

    function renameList(id, name) {
      const list = (settings.lists || []).find(l => l.id === id);
      if (!list || list.name === name) return;
      list.name = name;
      save({ lists: settings.lists });
    }

    function changeListMode(id, mode) {
      const list = (settings.lists || []).find(l => l.id === id);
      if (!list) return;
      list.mode = mode;
      save({ lists: settings.lists });
    }

    function changeProductiveMode(id, mode) {
      const list = (settings.lists || []).find(l => l.id === id);
      if (!list) return;
      if (!list.productive) list.productive = { mode: 'all-except-blocked', sites: [], apps: [] };
      list.productive.mode = mode;
      save({ lists: settings.lists });
    }

    function addToList(id, section, field, inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      const value = input.value.trim().toLowerCase();
      if (!value) return;
      input.value = '';
      const list = (settings.lists || []).find(l => l.id === id);
      if (!list) return;
      if (!list[section]) list[section] = {};
      if (!list[section][field]) list[section][field] = [];
      if (list[section][field].includes(value)) return;
      list[section][field].push(value);
      save({ lists: settings.lists });
    }

    function removeFromList(id, section, field, index) {
      const list = (settings.lists || []).find(l => l.id === id);
      if (!list) return;
      if (!list[section] || !list[section][field]) return;
      list[section][field].splice(index, 1);
      save({ lists: settings.lists });
    }

    /* ===== Nuclear Block ===== */

    function addNuclearSiteEntry() {
      const input = document.getElementById('addNuclearSite');
      const domain = input.value.trim().toLowerCase();
      if (!domain) return;
      input.value = '';
      const nuclear = settings.nuclearBlockData ? { ...settings.nuclearBlockData } : { sites: [] };
      if (!nuclear.sites) nuclear.sites = [];
      if (nuclear.sites.some(s => s.domain === domain)) return;
      nuclear.sites.push({
        domain, addedAt: Date.now(),
        cooldown1Ms: 86400000, cooldown2Ms: 64800000, unblockClickedAt: null,
      });
      save({ nuclearBlockData: nuclear });
    }

    function removeNuclearSite(index) {
      const nuclear = settings.nuclearBlockData ? { ...settings.nuclearBlockData } : { sites: [] };
      if (!nuclear.sites) nuclear.sites = [];
      nuclear.sites.splice(index, 1);
      save({ nuclearBlockData: nuclear });
    }

    /* ===== Reset ===== */

    async function resetSettings() {
      if (!confirm('Reset all settings to defaults? Nuclear blocks will be preserved.')) return;
      try {
        const nuclearBackup = settings.nuclearBlockData;
        await fetch('/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            workMinutes: 50, rewardMinutes: 10,
            strictMode: false, blockTaskManager: false,
            idleTimeoutSeconds: 180,
            nuclearBlockData: nuclearBackup,
          }),
        });
        await loadSettings();
        flashSaved();
      } catch (e) {
        console.error('Reset failed:', e);
      }
    }

    /* ===== Rendering ===== */

    function renderAll() {
      renderLists();
      renderNuclearBlock();
      // Sync dropdown
      populateSelect('idleTimeoutSeconds', IDLE_OPTIONS, settings.idleTimeoutSeconds);
    }

    function renderLists() {
      const container = document.getElementById('listsContainer');
      const lists = settings.lists || [];
      const canDelete = lists.length > 1;

      container.innerHTML = lists.map(list => {
        const isOpen = list.id === expandedListId;
        const blocked = list.blocked || {};
        const productive = list.productive || {};
        const sitesCount = (blocked.sites || []).length;
        const appsCount = (blocked.apps || []).length;
        const productiveMode = productive.mode || 'all-except-blocked';
        const prodSitesCount = (productive.sites || []).length;
        const prodAppsCount = (productive.apps || []).length;
        const summaryParts = [];
        if (sitesCount > 0) summaryParts.push(`${sitesCount} site${sitesCount !== 1 ? 's' : ''} blocked`);
        if (appsCount > 0) summaryParts.push(`${appsCount} app${appsCount !== 1 ? 's' : ''}`);
        if (productiveMode === 'all-except-blocked') {
          summaryParts.push('All sites & apps productive');
        } else {
          const prodParts = [];
          if (prodSitesCount > 0) prodParts.push(`${prodSitesCount} productive site${prodSitesCount !== 1 ? 's' : ''}`);
          if (prodAppsCount > 0) prodParts.push(`${prodAppsCount} productive app${prodAppsCount !== 1 ? 's' : ''}`);
          if (prodParts.length > 0) summaryParts.push(...prodParts);
        }
        const summary = summaryParts.length > 0 ? summaryParts.join(' · ') : 'No items';

        const modeOpts = MODE_OPTIONS.map(o =>
          `<option value="${o.value}"${o.value === list.mode ? ' selected' : ''}>${o.label}</option>`
        ).join('');

        const showWhitelistFields = productiveMode === 'whitelist';

        const whitelistFields = showWhitelistFields ? `
          <div class="card-field">
            <div class="card-field-label">Productive Sites</div>
            <div class="tag-list">${renderTags(productive.sites || [], `removeFromList.bind(null,'${list.id}','productive','sites')`)}</div>
            <div class="add-row">
              <input type="text" id="input-productive-sites-${list.id}" placeholder="e.g. stackoverflow.com"
                onkeydown="if(event.key==='Enter')addToList('${list.id}','productive','sites','input-productive-sites-${list.id}')">
              <button onclick="addToList('${list.id}','productive','sites','input-productive-sites-${list.id}')">Add</button>
            </div>
          </div>
          <div class="card-field">
            <div class="card-field-label">Productive Apps</div>
            <div class="tag-list">${renderTags(productive.apps || [], `removeFromList.bind(null,'${list.id}','productive','apps')`)}</div>
            <div class="add-row">
              <input type="text" id="input-productive-apps-${list.id}" placeholder="e.g. Code.exe"
                onkeydown="if(event.key==='Enter')addToList('${list.id}','productive','apps','input-productive-apps-${list.id}')">
              <button onclick="addToList('${list.id}','productive','apps','input-productive-apps-${list.id}')">Add</button>
            </div>
          </div>` : '';

        return `
          <div class="list-card${isOpen ? ' open' : ''}" id="list-card-${list.id}">
            <div class="list-card-header" onclick="toggleListCard('${list.id}')">
              <span class="list-card-arrow">&#9654;</span>
              <span class="list-card-name">${escHtml(list.name)}</span>
              <span class="${modeBadgeClass(list.mode)}">${modeBadgeLabel(list.mode)}</span>
              <span class="list-card-summary">${summary}</span>
            </div>
            <div class="list-card-body">
              <div class="card-field">
                <div class="card-field-label">Name</div>
                <input class="card-name-input" type="text" value="${escHtml(list.name)}"
                  onblur="renameList('${list.id}', this.value)"
                  onkeydown="if(event.key==='Enter')this.blur()">
              </div>
              <div class="card-field">
                <div class="card-field-label">Mode</div>
                <select class="card-mode-select" onchange="changeListMode('${list.id}', this.value)">${modeOpts}</select>
              </div>

              <div class="card-section-heading">What to Block</div>
              <div class="card-field">
                <div class="card-field-label">Blocked Sites</div>
                <div class="tag-list">${renderTags(blocked.sites || [], `removeFromList.bind(null,'${list.id}','blocked','sites')`)}</div>
                <div class="add-row">
                  <input type="text" id="input-blocked-sites-${list.id}" placeholder="e.g. tiktok.com"
                    onkeydown="if(event.key==='Enter')addToList('${list.id}','blocked','sites','input-blocked-sites-${list.id}')">
                  <button onclick="addToList('${list.id}','blocked','sites','input-blocked-sites-${list.id}')">Add</button>
                </div>
              </div>
              <div class="card-field">
                <div class="card-field-label">Blocked Apps</div>
                <div class="tag-list">${renderTags(blocked.apps || [], `removeFromList.bind(null,'${list.id}','blocked','apps')`)}</div>
                <div class="add-row">
                  <input type="text" id="input-blocked-apps-${list.id}" placeholder="e.g. discord.exe"
                    onkeydown="if(event.key==='Enter')addToList('${list.id}','blocked','apps','input-blocked-apps-${list.id}')">
                  <button onclick="addToList('${list.id}','blocked','apps','input-blocked-apps-${list.id}')">Add</button>
                </div>
              </div>
              <div class="card-field">
                <div class="card-field-label">Allowed Paths</div>
                <div class="card-field-sublabel">Exceptions within blocked sites</div>
                <div class="tag-list">${renderTags(blocked.allowedPaths || [], `removeFromList.bind(null,'${list.id}','blocked','allowedPaths')`)}</div>
                <div class="add-row">
                  <input type="text" id="input-blocked-allowedPaths-${list.id}" placeholder="e.g. youtube.com/veritasium"
                    onkeydown="if(event.key==='Enter')addToList('${list.id}','blocked','allowedPaths','input-blocked-allowedPaths-${list.id}')">
                  <button onclick="addToList('${list.id}','blocked','allowedPaths','input-blocked-allowedPaths-${list.id}')">Add</button>
                </div>
              </div>

              <div class="card-section-heading">What Counts as Productive</div>
              <div class="card-field">
                <div class="radio-group">
                  <label class="radio-label">
                    <input type="radio" name="prod-mode-${list.id}" value="all-except-blocked"
                      ${productiveMode === 'all-except-blocked' ? 'checked' : ''}
                      onchange="changeProductiveMode('${list.id}', 'all-except-blocked')">
                    All sites except blocked ones
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="prod-mode-${list.id}" value="whitelist"
                      ${productiveMode === 'whitelist' ? 'checked' : ''}
                      onchange="changeProductiveMode('${list.id}', 'whitelist')">
                    Only the sites I select
                  </label>
                </div>
              </div>
              ${whitelistFields}

              <button class="btn-delete-list" onclick="deleteList('${list.id}')"
                ${canDelete ? '' : 'disabled'}>Delete List</button>
            </div>
          </div>`;
      }).join('');
    }

    function toggleListCard(id) {
      expandedListId = expandedListId === id ? null : id;
      renderLists();
    }

    function renderNuclearBlock() {
      const container = document.getElementById('nuclearSitesTags');
      if (!container) return;
      const sites = settings.nuclearBlockData?.sites || [];
      container.innerHTML = sites.map((s, i) =>
        `<span class="tag">${escHtml(s.domain)}<button onclick="removeNuclearSite(${i})">&times;</button></span>`
      ).join('');
    }

    /* ===== Init ===== */

    setupSelect('idleTimeoutSeconds', parseInt);

    function connectWS() {
      const ws = new WebSocket(`ws://${location.host}`);
      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          if (msg.type === 'settings-updated') {
            settings = msg.data;
            renderAll();
          }
        } catch (e) {}
      };
      ws.onclose = () => setTimeout(connectWS, 2000);
    }

    connectWS();
    loadSettings();
  </script>
</body>
</html>
